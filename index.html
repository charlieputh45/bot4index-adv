<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <title>TG-INDEX</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
    body {
        background: #181a1b;
        color: #e0e0e0;
    }
    .poster-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
        gap: 1.2rem;
    }
    .poster-tile {
        background: #23272b;
        border-radius: 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.12);
        overflow: hidden;
        cursor: pointer;
        transition: box-shadow 0.2s, border-color 0.2s;
        border: 2px solid transparent;
        position: relative;
        padding: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .poster-tile:hover {
        box-shadow: 0 4px 16px rgba(0,0,0,0.25);
        border-color: #0d6efd;
    }
    .poster-img {
        width: 100%;
        height: auto;
        object-fit: contain;
        background: #181a1b;
        display: block;
        border-radius: 0.7rem;
        max-height: 350px;
    }
    /* Remove .poster-title styling since it's not used */
    .modal-header, .modal-body, .modal-footer {
        background: #23272b;
        color: #fff;
        text-align: center;
    }
    .tmdb-meta {
        font-size: 0.98rem;
        margin-bottom: 0.5rem;
        text-align: center;
    }
    .tmdb-poster-modal {
        width: 100%;
        max-width: 220px;
        border-radius: 0.7rem;
        margin-bottom: 1rem;
        display: block;
        margin-left: auto;
        margin-right: auto;
    }
    .file-card {
        background: #23272b;
        border-radius: 0.7rem;
        box-shadow: 0 1px 4px rgba(0,0,0,0.10);
        margin-bottom: 1rem;
        padding: 1rem 1.2rem;
        display: flex;
        flex-direction: column;    /* Always vertical */
        gap: 0.5rem;
        align-items: stretch;
        text-align: left;
    }
    .file-info-block {
        min-width: 0;
        margin-bottom: 0.2rem;
        word-break: break-all;
    }
    .file-label {
        font-size: 0.93em;
        color: #7da0fa;
        margin-bottom: 0.1em;
        font-weight: 500;
    }
    .file-value {
        color: #e0e0e0;
        font-size: 1em;
        word-break: break-all;
    }
    .file-name {
        font-weight: 600;
    }
    @media (max-width: 576px) {
        .poster-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 0.7rem;
        }
        .poster-img { max-height: 200px; }
        .tmdb-poster-modal { max-width: 100%; }
        .file-card {
            padding: 0.7rem 0.5rem;
        }
        .file-info-block {
            margin-bottom: 0.2rem;
        }
    }
    @media (max-width: 768px) {
        .file-card {
            flex-direction: column;
            align-items: stretch;
            text-align: center;
            padding: 0.7rem 0.5rem;
        }
        .file-info-block {
            min-width: 0;
            margin-bottom: 0.2rem;
        }
    }
    .tmdb-meta .rounded {
        border-radius: 0.5rem !important;
        background: #181a1b;
    }
    </style>
</head>
<body>
<div class="container py-4">
    <h2 class="mb-4 text-center" id="channelTitle">TG⚡️FLIX</h2>
    <div class="mb-3 text-center">
        <a href="nfiles.html" class="btn btn-outline-info btn-sm">Browse N Files</a>
    </div>
    <div class="mb-4 d-flex justify-content-center">
        <input type="text" class="form-control w-50" id="searchInput" placeholder="Search by title...">
    </div>
    <div id="posterGrid" class="poster-grid"></div>
    <div class="d-flex justify-content-center mt-3">
        <button id="loadMoreBtn" class="btn btn-primary">Load More</button>
    </div>
    <div class="d-flex justify-content-center mt-2">
        <div id="loadingSpinner" class="spinner-border text-primary" style="display:none" role="status"></div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="tmdbModal" tabindex="-1" aria-labelledby="tmdbModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="tmdbModalLabel"></h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body d-flex flex-column flex-md-row">
        <div class="flex-shrink-0 me-md-4 mb-3 mb-md-0 text-center">
            <img id="modalPoster" class="tmdb-poster-modal" src="" alt="Poster">
        </div>
        <div class="flex-grow-1">
            <div id="modalMeta"></div>
            <div id="modalStory" class="mb-3"></div>
            <div id="modalFiles"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const apiBase = ""; // Change to your FastAPI server if needed
let allTmdbResults = [];
let filteredResults = [];
let offset = 0;
const limit = 10; // or 20 if you prefer
let hasMore = true;
let currentQuery = "";
let currentCast = "";
let currentDirector = "";
let currentGenre = "";

const posterGrid = document.getElementById('posterGrid');
const loadMoreBtn = document.getElementById('loadMoreBtn');
const loadingSpinner = document.getElementById('loadingSpinner');
const searchInput = document.getElementById('searchInput');

loadMoreBtn.disabled = true;

function humanFileSize(bytes) {
    if (!bytes) return '';
    const thresh = 1024;
    if (Math.abs(bytes) < thresh) return bytes + ' B';
    const units = ['KB','MB','GB','TB','PB','EB','ZB','YB'];
    let u = -1;
    do {
        bytes /= thresh;
        ++u;
    } while(Math.abs(bytes) >= thresh && u < units.length - 1);
    return bytes.toFixed(1)+' '+units[u];
}

function renderPosters(results, append=false) {
    if (!append) posterGrid.innerHTML = "";
    results.forEach((entry, idx) => {
        const div = document.createElement('div');
        div.className = 'poster-tile fade-in';
        div.tabIndex = 0;
        div.setAttribute('role', 'button');
        div.setAttribute('aria-label', entry.title || "Poster");
        div.onclick = () => showTmdbModal(entry);
        div.innerHTML = `
            <img class="poster-img" src="${entry.poster_url || 'https://i.ibb.co/qzmwLvx/No-Image-Available.jpg'}" alt="Poster">
        `;
        posterGrid.appendChild(div);
    });
}

function showTmdbModal(entry) {
    // Helper to render only TMDB info and Get Files button
    function renderTmdbInfo() {
        document.getElementById('tmdbModalLabel').textContent = entry.title || '';
        document.getElementById('modalPoster').src = entry.poster_url || 'https://i.ibb.co/qzmwLvx/No-Image-Available.jpg';

        // Director profiles
        let directorHtml = "";
        if (entry.directors && entry.directors.length) {
            directorHtml = `<div class="tmdb-meta"><strong>Directors:</strong><div class="d-flex flex-wrap justify-content-center gap-2 mt-2">`;
            entry.directors.forEach(director => {
                directorHtml += `
                    <div class="text-center director-profile" style="width:80px;cursor:pointer;" data-director="${encodeURIComponent(director.name)}">
                        <img src="${director.profile_path || 'https://i.ibb.co/qzmwLvx/No-Image-Available.jpg'}" alt="${director.name}" class="rounded mb-1" style="width:60px;height:90px;object-fit:cover;box-shadow:0 1px 4px #0002;">
                        <div style="font-size:0.93em;word-break:break-word;">${director.name}</div>
                    </div>
                `;
            });
            directorHtml += `</div></div>`;
        }

        // Cast profiles
        let castHtml = "";
        if (entry.stars && entry.stars.length) {
            castHtml = `<div class="tmdb-meta"><strong>Stars:</strong><div class="d-flex flex-wrap justify-content-center gap-2 mt-2">`;
            entry.stars.forEach(star => {
                castHtml += `
                    <div class="text-center cast-profile" style="width:80px;cursor:pointer;" data-cast="${encodeURIComponent(star.name)}">
                        <img src="${star.profile_path || 'https://i.ibb.co/qzmwLvx/No-Image-Available.jpg'}" alt="${star.name}" class="rounded mb-1" style="width:60px;height:90px;object-fit:cover;box-shadow:0 1px 4px #0002;">
                        <div style="font-size:0.93em;word-break:break-word;">${star.name}</div>
                    </div>
                `;
            });
            castHtml += `</div></div>`;
        }

        // Genre tags (clickable)
        let genreHtml = "";
        if (entry.genre) {
            const genres = entry.genre.split(',').map(g => g.trim()).filter(Boolean);
            genreHtml = `<div class="tmdb-meta"><strong>Genre:</strong> `;
            genres.forEach(genre => {
                genreHtml += `<span class="badge bg-info text-dark genre-badge" style="cursor:pointer;margin:0 2px;" data-genre="${encodeURIComponent(genre)}">${genre}</span>`;
            });
            genreHtml += `</div>`;
        }

        document.getElementById('modalMeta').innerHTML = `
            <div class="tmdb-meta"><strong>Type:</strong> ${entry.tmdb_type || ''}</div>
            <div class="tmdb-meta"><strong>Rating:</strong> ${entry.rating || ''}/10</div>
            <div class="tmdb-meta"><strong>Language:</strong> ${entry.language || ''}</div>
            ${genreHtml}
            <div class="tmdb-meta"><strong>Release Date:</strong> ${entry.release_date || ''}</div>
            ${directorHtml}
            ${castHtml}
            ${entry.trailer_url ? `<div class="tmdb-meta"><a href="${entry.trailer_url}" target="_blank" class="btn btn-outline-info btn-sm mt-1">Watch Trailer</a></div>` : ""}
        `;
        document.getElementById('modalStory').innerHTML = entry.story ? `<div><strong>Story:</strong> ${entry.story}</div>` : "";
        document.getElementById('modalFiles').innerHTML = `
            <div class="d-flex justify-content-center">
                <button id="getFilesBtn" class="btn btn-primary mt-2">Get Files</button>
            </div>
        `;
        document.getElementById('getFilesBtn').onclick = renderFilesInfo;

        // Cast click handler
        document.querySelectorAll('.cast-profile').forEach(el => {
            el.onclick = function() {
                const castName = decodeURIComponent(this.getAttribute('data-cast'));
                bootstrap.Modal.getOrCreateInstance(document.getElementById('tmdbModal')).hide();
                searchByCastName(castName);
            };
        });

        // Director click handler
        document.querySelectorAll('.director-profile').forEach(el => {
            el.onclick = function() {
                const directorName = decodeURIComponent(this.getAttribute('data-director'));
                bootstrap.Modal.getOrCreateInstance(document.getElementById('tmdbModal')).hide();
                searchByDirectorName(directorName);
            };
        });

        // Genre click handler
        document.querySelectorAll('.genre-badge').forEach(el => {
            el.onclick = function() {
                const genreName = decodeURIComponent(this.getAttribute('data-genre'));
                bootstrap.Modal.getOrCreateInstance(document.getElementById('tmdbModal')).hide();
                searchByGenre(genreName);
            };
        });
    }

    // Helper to render file info cards
    function renderFilesInfo() {
        // Clear TMDB info and story
        document.getElementById('modalMeta').innerHTML = "";
        document.getElementById('modalStory').innerHTML = "";

        let filesHtml = "";
        if (entry.files && entry.files.length) {
            filesHtml = `
            <div class="mb-2"><strong>Files:</strong></div>
            ${entry.files.map(file => `
                <div class="file-container mb-3">
                    <div class="file-card">
                        <div class="file-info-block">
                            <div class="file-value file-name">${file.file_name || ''}</div>
                        </div>
                        <div class="file-info-block">
                            <div class="file-label">Size / Format</div>
                            <div class="file-value">${humanFileSize(file.file_size) || ''}${file.file_format ? ' · ' + file.file_format : ''}</div>
                        </div>
                        <div class="file-info-block">
                            <div class="file-label">Added On</div>
                            <div class="file-value">${file.date || ''}</div>
                        </div>
                        <div class="file-info-block">
                            <div class="file-value">
                                <a class="btn btn-success btn-sm" href="${file.telegram_link}" target="_blank">Send</a>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('')}
            `;
        } else {
            filesHtml = `<div class="text-muted">No files available.</div>`;
        }
        document.getElementById('modalFiles').innerHTML = filesHtml +
            `<div class="d-flex justify-content-center">
                <button id="backToInfoBtn" class="btn btn-secondary mt-2">Back to Info</button>
            </div>`;
        document.getElementById('backToInfoBtn').onclick = renderTmdbInfo;
    }

    // Initial render: TMDB info + Get Files button
    renderTmdbInfo();

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('tmdbModal'));
    modal.show();
}

async function loadAllTmdbFiles(reset=false) {
    if (reset) {
        offset = 0;
        allTmdbResults = [];
        posterGrid.innerHTML = "";
        hasMore = true;
    }
    if (!hasMore) return;
    loadMoreBtn.style.display = 'none';
    loadingSpinner.style.display = 'block';
    try {
        const url = new URL(`${apiBase}/api/all-tmdb-files`);
        url.searchParams.set("offset", offset);
        url.searchParams.set("limit", limit);
        if (currentQuery) url.searchParams.set("q", currentQuery);
        if (currentCast) url.searchParams.set("cast", currentCast);
        if (currentDirector) url.searchParams.set("director", currentDirector);
        if (currentGenre) url.searchParams.set("genre", currentGenre);

        const resp = await fetch(url);
        if (!resp.ok) throw new Error("API error");
        const data = await resp.json();
        const newResults = data.results || [];
        if (reset) {
            allTmdbResults = newResults;
            posterGrid.innerHTML = "";
        } else {
            allTmdbResults = allTmdbResults.concat(newResults);
        }
        renderPosters(newResults, !reset);
        offset += limit;
        hasMore = data.has_more;
        loadMoreBtn.style.display = hasMore ? 'block' : 'none';
        loadMoreBtn.disabled = !hasMore;
    } catch (e) {
        alert("Failed to load TMDB data.");
    } finally {
        loadingSpinner.style.display = 'none';
    }
}

async function searchByCastName(castName) {
    offset = 0;
    currentQuery = "";
    currentCast = castName;
    currentDirector = "";
    currentGenre = "";
    posterGrid.innerHTML = "";
    loadingSpinner.style.display = 'block';
    loadMoreBtn.style.display = 'none';
    try {
        // Query the backend for cast search
        const url = new URL(`${apiBase}/api/all-tmdb-files`);
        url.searchParams.set("offset", 0);
        url.searchParams.set("limit", limit);
        url.searchParams.set("cast", castName);

        const resp = await fetch(url);
        if (!resp.ok) throw new Error("API error");
        const data = await resp.json();
        const results = data.results || [];
        allTmdbResults = results; 
        renderPosters(results, false);
        offset = limit; 
        hasMore = data.has_more;
        loadMoreBtn.style.display = hasMore ? 'block' : 'none';
        loadMoreBtn.disabled = !hasMore;
    } catch (e) {
        alert("Failed to search by cast.");
    } finally {
        loadingSpinner.style.display = 'none';
    }
}

async function searchByDirectorName(directorName) {
    offset = 0;
    currentQuery = "";
    currentCast = "";
    currentDirector = directorName;
    currentGenre = "";
    posterGrid.innerHTML = "";
    loadingSpinner.style.display = 'block';
    loadMoreBtn.style.display = 'none';
    try {
        const url = new URL(`${apiBase}/api/all-tmdb-files`);
        url.searchParams.set("offset", 0);
        url.searchParams.set("limit", limit);
        url.searchParams.set("director", directorName);

        const resp = await fetch(url);
        if (!resp.ok) throw new Error("API error");
        const data = await resp.json();
        const results = data.results || [];
        allTmdbResults = results;
        renderPosters(results, false);
        offset = limit;
        hasMore = data.has_more;
        loadMoreBtn.style.display = hasMore ? 'block' : 'none';
        loadMoreBtn.disabled = !hasMore;
    } catch (e) {
        alert("Failed to search by director.");
    } finally {
        loadingSpinner.style.display = 'none';
    }
}

async function searchByGenre(genreName) {
    offset = 0;
    currentQuery = "";
    currentCast = "";
    currentDirector = "";
    currentGenre = genreName;
    posterGrid.innerHTML = "";
    loadingSpinner.style.display = 'block';
    loadMoreBtn.style.display = 'none';
    try {
        const url = new URL(`${apiBase}/api/all-tmdb-files`);
        url.searchParams.set("offset", 0);
        url.searchParams.set("limit", limit);
        url.searchParams.set("genre", genreName);

        const resp = await fetch(url);
        if (!resp.ok) throw new Error("API error");
        const data = await resp.json();
        const results = data.results || [];
        allTmdbResults = results;
        renderPosters(results, false);
        offset = limit;
        hasMore = data.has_more;
        loadMoreBtn.style.display = hasMore ? 'block' : 'none';
        loadMoreBtn.disabled = !hasMore;
    } catch (e) {
        alert("Failed to search by genre.");
    } finally {
        loadingSpinner.style.display = 'none';
    }
}

loadMoreBtn.addEventListener('click', () => {
    loadAllTmdbFiles(false);
});

searchInput.addEventListener('input', () => {
    currentQuery = searchInput.value.trim();
    currentCast = "";
    currentDirector = "";
    currentGenre = "";
    loadAllTmdbFiles(true);
});

window.addEventListener('DOMContentLoaded', () => {
    loadAllTmdbFiles(true);
});
</script>
</body>
</html>